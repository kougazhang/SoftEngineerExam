# 04 流水线

## 考察

必考. 经常考察流水线计算的问题

## 4.1 流水线概念

**指令执行的三个阶段**

取指 -> 分析 -> 执行 -> 写回运算结果 (视频中未列出该步骤)

+ 取指: 把指令从内存加载到指令寄存器中, 这一过程成为取指 (具体参见, CPU 控制器)
+ 分析: 译码, 将存储器由取出的指令进行翻译. (具体参见, CPU 控制器)
+ 执行: 对指令进行真正的运算. (具体参见, CPU 运算器)

**没有流水线的情况下, 不能充分利用 CPU**

在未使用流水线时, 指令是逐条执行的, 这样会导致部件的浪费.

**使用流水线**

多条指令并发执行, 如取指的部件不再等到第一条指令执行完毕后再执行第 2 条指令的取指而是在第一条指令取指完毕后就立即进行第 2 条指令的取指. 

这个思想与汽车流水线装配非常类似.

## 4.2 流水线周期及流水线执行时间计算

### 计算流水线周期

流水线周期 = 执行时间最长的那一阶段

### 计算 n 条指令的计算时间

大部分情况下, 考试考查的是理论公式, 少部分情况是实际公式

**理论公式**

```
1 条指令执行时间 + (n - 1) * 流水线周期
// 1 条指令执行时间: 3 个阶段执行时间的总和
```

**实际公式**

```
// 1 条指令执行的阶段为 k

(k + n -1 ) * 流水线周期
```

## 4.3 流水线吞吐率计算

### 吞吐率

吞吐率: 单位时间内处理任务的数量

### 流水线的吞吐率

```
指令条数 / 指令时间
```

用上述公式计算 4.2 节中的题中吞吐率: `100/203`

### 最大吞吐率

```
1/一个流水线周期的时间
```

## 4.4 流水线的加速比计算

### 流水线的加速比

```
加速比 = 不使用的流水线的时间 / 使用流水线的时间
```

4.2 中的题: `(5*100)/203`

### 流水线的效率

```
n 个任务占用的时空区 / k 个流水线的总时空区

n 个任务占用的时空区 = 1 个任务指令执行的时间 * n 个任务
```

每个阶段的时长相等, 这样流水线的效率最高